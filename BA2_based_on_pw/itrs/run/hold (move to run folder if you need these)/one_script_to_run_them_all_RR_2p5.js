// BA2.5!  REVIEW AND ROUTINES                                                                                                                              |_|    //CREATOR JY, UPDATED BY EM//CREATED 2019-02-19//UPDATED 2021-something-something//VERSION 2.5.1//use the alternate one here if you're running this on VPN or otherwise can't get it to see /Volumes/BECvar bec_path = '/Volumes/BEC';// var bec_path = Folder.selectDialog('Select the BEC root folder.');// #include bec_path + '/15 User Files/INDD SCRIPTS/primitive/main.js';#include '/Volumes/BEC/15 User Files/INDD SCRIPTS/primitive/main.js';var utility_path = '/Users/' + $.getenv('USER') + '/Library/Preferences/Adobe InDesign/Version 11.0/en_US/Scripts/Scripts Panel/team scripts/Jason/Utility';// var itrs_root_path = '/Users/' + $.getenv('USER') + '/Library/Preferences/Adobe InDesign/Version 11.0/en_US/Scripts/Scripts Panel/team scripts/Jason/BA2_based_on_pw/itrs';// var region = 'sni';// var region = 'tennessee';var region = 'national';// var region = 'florida';$.evalFile(utility_path+'/console.js');$.evalFile(utility_path+'/exporter.js');$.evalFile(utility_path+'/zone.js');$.evalFile(utility_path+'/library.js');$.evalFile(utility_path+'/json.js');start_log('log_BA2_eng_2p5_' + region + '_' + app.getWWUser());$.evalFile(itrs_root_path+'/data/products.js');$.evalFile(itrs_root_path+'/data/heidisongs.js');$.evalFile(itrs_root_path+'/data/image_links_data.js');var indd_folder = Folder(itrs_root_path+'/indd_rr');var collect_headers = false;var current_package, current_week, current_day, current_lesson, current_lesson_type, current_package_folder, current_images_path, figures_id, images_list, current_section, datamap;var eplanner_toc_json_content = '';var projects_folder = Folder(bec_path + '/15 User Files/INDD SCRIPTS/primitive/_JY_BU/JasonONE_DRIVE_UNSORTED/OneDrive - Benchmark Education/projects');var dev_folder = Folder(projects_folder+'/BA2/itrs/dev'); // var output_folder = create_folder(projects_folder+'/BA2/itrs/output_edreports_florida');var output_folder = create_folder(projects_folder+'/BA2/itrs/output_florida_rr_2p5');// var output_folder = create_folder(projects_folder+'/BA2/itrs/output_navfix_florida_20201112');var packages_folder = create_folder(projects_folder+'/BA2/itrs/packages_2p5');var dmv_folder = Folder(projects_folder+'/digitalMediaViewer/products/BA2');var input_pdfs_folder = Folder(dmv_folder+'/packages');var package_infos = [{grade: 'K', unit: 0,  national: {xcode: 'X72541', dmv: 'X60871'}, florida: {xcode: 'X72535', dmv: 'X60871'}, sni: {xcode: 'X70969', dmv: 'X60871'}, dossier_name: 'O-Y40788', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 20}] },{grade: '1', unit: 0,  national: {xcode: 'X72542', dmv: 'X60881'}, florida: {xcode: 'X72536', dmv: 'X60881'}, sni: {xcode: 'X70979', dmv: 'X60881'}, dossier_name: 'O-Y40793', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 20}] },{grade: '2', unit: 0,  national: {xcode: 'X72543', dmv: 'X60891'}, florida: {xcode: 'X72537', dmv: 'X60891'}, sni: {xcode: 'X70989', dmv: 'X60891'}, dossier_name: 'O-Y40798', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 20}] },{grade: '3', unit: 0,  national: {xcode: 'X72544', dmv: 'X60901'}, florida: {xcode: 'X72538', dmv: 'X60901'}, sni: {xcode: 'X70999', dmv: 'X60901'}, dossier_name: 'O-Y40023', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 15}] }, //15 14 14{grade: '4', unit: 0,  national: {xcode: 'X72545', dmv: 'X60911'}, florida: {xcode: 'X72539', dmv: 'X60911'}, sni: {xcode: 'X71009', dmv: 'X60911'}, dossier_name: 'O-Y40028', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 15}] },{grade: '5', unit: 0,  national: {xcode: 'X72546', dmv: 'X60921'}, florida: {xcode: 'X72540', dmv: 'X60921'}, sni: {xcode: 'X71019', dmv: 'X60921'}, dossier_name: 'O-Y40033', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 15}] },{grade: '6', unit: 0,  national: {xcode: 'X72547', dmv: 'X60931'}, florida: {xcode: 'DO NOT RUN', dmv: ''}, sni: {xcode: 'X71029', dmv: 'X60931'}, dossier_name: 'O-Y40038', language: 'en', woodwing: false, lessons: [{type: 'lesson', total: 15}] },];function make_packages(){	package_infos.forEach(function(package_info){		var product_package = new Package(package_info);		current_package = product_package;		// product_package.check_link_statuses();		product_package.build();	});}function Package(package_info){	this.info = package_info;	this.grade = package_info.grade;	this.unit = package_info.unit;	this.volume = this.unit <= 5 ? 1 : 2;	this.ycode = package_info.dossier_name.replace(/O-/, '');	this.xcode = package_info[region].xcode;	this.dmv = package_info[region].dmv;	this.language = package_info.language;	this.lessons_info = package_info.lessons;		this.export_images = true;	this.csv_path = bec_path + '/15 User Files/INDD SCRIPTS/primitive/_JY_BU/JasonONE_DRIVE_UNSORTED/OneDrive - Benchmark Education/projects/BA2/itrs/csv';	this.csv_file = File(this.csv_path+'/g'+this.grade.toLowerCase()+'/g'+this.grade.toLowerCase()+'_rr_'+region+'_nav_csv.csv');		}Package.prototype.build = function(){		this.product_folder = create_folder(output_folder+'/'+this.xcode);	// try{		this.initialize();		this.make_nav();				// this.make_unit_opener_page();		this.copy_itrs_pdfs();		this.make_lesson_pages(1);		// this.make_lesson_pages(2);		// this.make_lesson_pages(3);		this.stack();		this.finalize();		// app.seriesTracker(File('/Volumes/BEC/15 User Files/INDD SCRIPTS/trackers/phonics_workshop_itrs.csv'), this.xcode);	// }catch(e){warning_message("failed on: "+this.xcode+', error: '+e);}};Package.prototype.initialize = function(){		$.evalFile(itrs_root_path+'/nav/initialize.js');	// if(!this.csv_file.exists){		this.make_csv_file();	// }	data_map = new DataMap(this.csv_file, Record, '0');};Package.prototype.make_csv_file = function(){	$.evalFile(itrs_root_path+'/nav/csv_maker_RR_2p5.js');	this.lesson_titles = [];	this.get_lesson_titles();		var text = '';	log('Grade: ' + current_package.grade);	// switch(current_package.grade){	// 	case 'K': case '1': text = lowergrade_template(); break;	// 	case '2': text = grade2_template(); break;	// 	case '3': case '4': case '5': case '6': text = uppergrade_template(); break;	// 	default:	// }	text = allgrades_template();	log(text);	this.csv_file = create_file(this.csv_file);	this.csv_file.open('w');	this.csv_file.write(text);	this.csv_file.close();};Package.prototype.get_lesson_titles = function(){		$.evalFile(itrs_root_path+'/nav/csv_maker_RR_2p5.js');	this.lessons_info.forEach(function(lesson_info){			var lesson_component = new LessonComponent(lesson_info);	});};Package.prototype.make_nav = function(){	$.evalFile(itrs_root_path+'/nav/nav_maker_RR_2p5.js');	datamap = new DataMap(this.csv_file, Navigation, '0');	datamap.write_to_files();};Package.prototype.copy_itrs_pdfs = function(){	$.evalFile(itrs_root_path+'/main/pdfs/pdfs.js');	var self = this;	var output_pdfs_folder = create_folder(output_folder+'/'+this.xcode+'/pdfs');	output_pdfs_folder.burn();	output_pdfs_folder = create_folder(output_folder+'/'+this.xcode+'/pdfs');	var grade_folder = create_folder(output_pdfs_folder+'/grade'+this.grade.toLowerCase());	var unit_folder = create_folder(grade_folder+'/rr');	var rr_folder = create_folder(unit_folder+'/week1');	var grade = this.grade;	var lower = true;	if(grade.match(/[3456]/)) lower = false;	var unit = this.unit;	var volume = this.volume;	var id = grade+unit;	//overview and unit resources PDFs	//grab the two CV pdfs not in the shell (one is by grade, the other is global)	var pdf_assets_folder;	pdf_assets_folder = Folder(projects_folder+'/BA2/itrs/assets/pdfs/rr/' + region);	var pdfFiles = pdf_assets_folder.getFiles();	var mlaagRegex = new RegExp('mlaag_'+this.grade, 'i');	var l = pdfFiles.length;	for(var x = 0; x < l; x++)	{		var pdfFile = pdfFiles[x];		if(!!pdfFile.name.match(/\.ds_store/i)){continue;}		if(!!pdfFile.name.match(mlaagRegex))			pdfFile.copy(Folder(rr_folder+'/mini-lessons-at-a-glance.pdf'));	}	close_application('Adobe Acrobat');	// function copy_pdf(number, path){	// 	var pdf_file = File(input_pdfs_folder+'/en/florida_2p5/'+self.dmv+'/pdfs/'+number+'.pdf');			// 	if(!File(path).exists){	// 		pdf_file.copy(path);	// 	}	// }};function combine_pdfs(folder){	if(folder.getFiles().length > 0){		use_applescript(folder);				}	folder.burn();}	function split_pdfs(file, split_amount){		var folder = file.parent;	var filename = file.name.replace(/\.\w+$/, '');	var text = '';	text += 'tell application "Adobe Acrobat"\r';	text += '\tclose all docs saving no\r';	text += '\topen "'+file.fsName+'"\r';	text += '\tset activedoc to document 1\r';	text += '\tset filepath to "'+folder.fsName+'"\r';	text += '\tset filename to "'+filename.toString()+'"\r';	text += '\tset page_index to 1\r';	text += '\tset split_amount to '+split_amount.toString()+'\r';	text += '\tset total_pages to count of pages of activedoc\r';	text += '\tset loop_total to round (total_pages / split_amount)\r';	text += '\tset x to 1\r';	text += '\trepeat loop_total times\r';	text += '\t\tmake new document\r';	text += '\t\tset newdoc to document 2\r';	text += '\t\tbring to front newdoc\r';	text += '\t\tinsert pages newdoc after 0 from activedoc starting with page_index number of pages split_amount\r';	text += '\t\tset pagecount to count of pages of newdoc\r';	text += '\t\tdelete pages newdoc first pagecount last pagecount\r';	text += '\t\tsave newdoc to filepath & "/" & filename & x & ".pdf"\r';	text += '\t\tclose document 2\r';	text += '\t\tset page_index to page_index + split_amount\r';	text += '\t\tset x to x + 1\r';	text += '\tend repeat\r';	text += 'end tell	\r';	app.doScript(text, ScriptLanguage.APPLESCRIPT_LANGUAGE);}function use_applescript(folder){		var text = '';	text += 'set pdf_files to {}\r';			var files = folder.getFiles('*.pdf');	files.sort(function(a, b){		return parseInt(a.name.replace(/_/g, '')) > parseInt(b.name.replace(/_/g, ''));	});	var l = files.length;	for(var x = 0; x < l; x++){		var file = files[x];		text += 'set file'+x+' to "Macintosh HD'+folder.fsName.replace(/\//g, ':')+':'+file.name+'" as alias\r';		text += 'set end of pdf_files to file'+x+'\r';	}		text += 'tell application "Adobe Acrobat"\r';	text += '	set x to 1\r';	text += '	repeat with pdf_file in pdf_files	\r';	text += '		open pdf_file with invisible\r';	text += '		if (x = 1) then\r';	text += '			set Master_Doc to document 1\r';	text += '		else\r';	text += '			set pdf_doc to document 2\r';	text += '			set PageCount to count of pages of Master_Doc\r';	text += '			set pdf_doc_PageCount to count of pages of pdf_doc\r';	text += '			insert pages Master_Doc after PageCount from pdf_doc starting with 1 number of pages pdf_doc_PageCount\r';	text += '			close pdf_doc without saving\r';	text += '		end if\r';	text += '		set x to x + 1\r';	text += '	end repeat\r';	text += '	save document 1 to file "Macintosh HD'+folder.parent.fsName.replace(/\//g, ':')+':'+folder.name+'.pdf"\r';	text += '	close document 1\r';		text += 'end tell\r';		app.doScript(text, ScriptLanguage.APPLESCRIPT_LANGUAGE);}// Package.prototype.make_overview_pages = function(){	// 	$.evalFile(itrs_root_path+'/main/overview/inquiry_project.js');// 	this.inquiry_project = new InquiryProject();// 	close_all_terminal_windows();// 	$.evalFile(itrs_root_path+'/main/overview/inquiry_project.js');// 	this.inquiry_project = new InquiryProject();// 	close_all_terminal_windows();// 	$.evalFile(itrs_root_path+'/main/overview/inquiry_project.js');// 	this.inquiry_project = new InquiryProject();// 	close_all_terminal_windows();// };// Package.prototype.make_unit_resources_pages = function(){// 	$.evalFile(itrs_root_path+'/main/unit_resources/inquiry_project.js');// 	this.inquiry_project = new InquiryProject();// 	close_all_terminal_windows();// }// Package.prototype.make_secrl_pages = function(){		// 	$.evalFile(itrs_root_path+'/main/unit_resources/secrl.js');// 	this.secrl  = new SECRL();// 	close_all_terminal_windows();// };// Package.prototype.make_about_pages = function(type, week){	// 	$.evalFile(itrs_root_path+'/main/week/about.js');// 	var self = this;// 	self.lessons_info.forEach(function(lesson_info){// 		current_lesson_type = lesson_info.type;// 		if(!type || type == 'all' || lesson_info.type == type && lesson_info.total > 0){// 			var about = new About(week);// 		}// 	});// 	close_all_terminal_windows();// };// Package.prototype.make_guide_to_sr_pages = function(week){	// 	week = !!week ? week : false;// 	if(!!current_package.grade.match(/[k12]/i)){ // 		$.evalFile(itrs_root_path+'/main/week/guide_to_shared_reading.js');// 		var self = this;// 		self.lessons_info.forEach(function(lesson_info){// 			current_lesson_type = lesson_info.type;		// 			if(lesson_info.type == 'sr')  { self.sr_about  = new GuideToSharedReading(week); }		// 		});// 		close_all_terminal_windows();// 	}// };// Package.prototype.routines = function(lesson){	// 	$.evalFile(itrs_root_path+'/launch/routines.js');	// 	new Routines(lesson);// };// Package.prototype.mini_lessons = function(lesson){	// 	$.evalFile(itrs_root_path+'/launch/mini-lessons.js');	// 	new MiniLessons(lesson);// };Package.prototype.make_lesson_pages = function(week, day){		$.evalFile(itrs_root_path+'/main/week/lessons_RR_2p5.js');		var self = this;	new LessonComponent(week, day);	};Package.prototype.make_unit_opener_page = function(){	log('filling in unit opener html...');	var self = this;	//open target html file	var html_file;	this.package_folder = Folder(output_folder+separator+current_package.xcode);	// alert(this.package_folder+'/html/grade'+this.grade+'/unit'+this.unit+'/unit_resources/unit_opener.html');	html_file = File(this.package_folder+'/html/grade'+this.grade+'/unit'+this.unit+'/unit_resources/unit_opener.html');	html_file.encoding = 'UTF-8';	html_file.lineFeed = 'Unix';	html_file.open('r');	var text = html_file.read();	// alert(text);	html_file.close();	//set up new main tag	var main = '';	main += '</nav>\r';	main += '<div class="clearfix"></div>\r';	main += '<main>\r';	//get the stuff that goes in the main tag from edgar's files	var opener_file;	opener_file = File(projects_folder+'/BA2/itrs/assets/unitopeners_2p5/grade'+this.grade.toUpperCase()+'unit'+this.unit+'.txt');	// opener_file = File.openDialog('sddgsdf');	opener_file.encoding = 'UTF-8';	opener_file.lineFeed = 'Unix';	opener_file.open('r');	var opener_text = opener_file.read();	opener_file.close();	//add that and close new main tag	main += opener_text;	main += '</main>\r';	//replace default main tag and save	text = text.replace(/<\/nav>(.|\r|\n)*<\/main>/, main);  	html_file.open('w');	html_file.write(text);	html_file.close();	log('...done!');};// Package.prototype.make_srff_pages = function(){	// 	if(!!current_package.grade.match(/[3456]/i)){ // 		$.evalFile(itrs_root_path+'/main/additional_resources/shared_reading_for_fluency.js');// 		(3).forEvery(function(x){// 			var week = x+1;// 			var filename = current_package.ycode+'_TRS_SR_G'+current_package.grade+'_U'+current_package.unit+'_L'+week;// 			new SharedReadingForFluency(filename, week);// 		});// 		close_all_terminal_windows();// 	}// };Package.prototype.stack = function(){			var files = this.product_folder.getFiles();	var l = files.length;	for(var x = 0; x < l; x++){		var file = files[x];		if(!file.type){ file.copy(Folder(dev_folder+'/content/'+file.name)); }else{ file.copy(dev_folder+'/content/'+file.name); }	}};Package.prototype.finalize = function(){		this.package_folder = create_folder(packages_folder+'/'+region+'_2p5_rr/'+this.xcode);	this.product_folder.copy(this.package_folder);	this.package_assets();	this.place_library_thumbnail();	this.create_json();};Package.prototype.package_assets = function(){	var assets_folder;	// if(this.unit == 0){	// 	assets_folder = Folder(projects_folder+'/BA2/itrs/assets/launch');	// }else{		assets_folder = Folder(projects_folder+'/BA2/itrs/assets/itrs');	// }	var files = assets_folder.getFiles();	var l = files.length;	for(var x = 0; x < l; x++){		var file = files[x];		if(!!file.name.match(/\.ds_store/i)){continue;}		file.copy(Folder(this.package_folder+'/'+file.name));	}};Package.prototype.place_library_thumbnail = function(){		var library_thumbnails_folder = Folder(projects_folder+'/BA2/itrs/thumbnails/itrs');	var files = library_thumbnails_folder.getFiles();	var l = files.length;		for(var x = 0; x < l; x++){		var file = files[x];		if(!!file.name.match(/\.ds_store/i)){continue;}		if(!!file.name.match(RegExp(this.xcode, 'i'))){		//this line was "this.dmv" but that was the old, this is the new			file.copy(File(this.package_folder+'/bu_library_thumbnail_'+this.xcode));		}	}};Package.prototype.create_json = function(){  var text = '';  var opener = '';  opener = 'html/grade'+this.grade.toLowerCase()+'/rr/week1/mini-lessons-at-a-glance.html';  text += '{\r';  text += '\t"launchPage":"'+opener+'",\r';  if(this.grade.match(/[3456]/)) text += '\t"title":"Grade '+this.grade+', Review and Routines",\r';  else text += '\t"title":"Grade '+this.grade+', Foundations and Routines",\r';  text += '\t"vcode":"'+this.xcode+'",\r';  //eplanner stuff  text += '\t"pageIds": {\r';  eplanner_toc_json_content = eplanner_toc_json_content.slice(0, -1); //get rid of the last comma  eplanner_toc_json_content = eplanner_toc_json_content.replace(/\,/g, ',\r');  eplanner_toc_json_content += '\r';  text += eplanner_toc_json_content;  text += '\t}\r';  eplanner_toc_json_content = '';  text += '}\r';  var json_file = create_file(this.package_folder+'/toc.json');  json_file.lineFeed = 'Unix';  json_file.encoding = 'UTF-8';  json_file.open('w');  json_file.write(text);  json_file.close();};(function(){			notifications_off();	set_image_export_preferences();			make_packages();			})();end_log();